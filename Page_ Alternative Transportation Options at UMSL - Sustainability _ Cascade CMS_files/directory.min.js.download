function sortByKeyAsc(array, key) {
  return array.sort(function (a, b) {
    var x = a[key];
    var y = b[key];
    return (x < y ? -1 : (x > y ? 1 : 0));
  });
}

function checkResults() {
  $(dirItemsList + "> .noresults").remove();
  if ($(".filter-match").length === 0) {
    $(dirItemsList).prepend("<div class='noresults text-center'><p>Sorry, no matches found. Please adjust your search.</p></div>");
    $("#pagination").hide();
  } else {
    $("#pagination").show();
  }
}

function search(e) {
  textSearch = $("#searchDir").val().toLowerCase();
  console.log(textSearch);

  if (textSearch.length > 0) {
    categoryClass = $("select#dirDept").val();
    $(".filter-match").each(function (e) {
      if (
        !$(this).find(".panel-title").text().toLowerCase().match(textSearch) &&
        !$(this).find(".depts").text().toLowerCase().match(textSearch) &&
        !$(this).find(".tags").text().toLowerCase().match(textSearch)
      ) {
        $(this).removeClass("filter-match");
      }
    });
  }

  $(".dirItems .dirItem").sort(function (a, b) {
    return $(a).data(dirSort) > $(b).data(dirSort) ? 1 : -1;
  }).appendTo(".dirItems");
}

function dirDeptSearch(e) {
  categoryClass = $("select#dirDept").val();
  if (e == "text") {
    $(".dirItem").each(function () {
      if ($(this).hasClass(categoryClass)) {
        $(this).addClass("filter-match");
      }
    });
  } else {
    $(".filter-match").each(function () {
      if (!$(this).hasClass(categoryClass)) {
        $(this).removeClass("filter-match");
      }
    });
  }
}

function showPagination() {
  if (itemsPerPage != "All") {
    runPagination();
  }
}

function runMatchHeight() {
  if (listType == "list" && imageType == "bgImage") {
    $(".dirItem:visible .panel-body .row > div").matchHeight();
    $(".dirItem:visible .panel-footer").matchHeight();
  } else {
    $(".dirItem:visible .panel-body").matchHeight();
    $(".dirItem:visible .panel-footer").matchHeight();
  }
}

function runPagination() {
  dirDataSet = $("<div />");
  $(dirItemsList).children(dirListItem).appendTo(dirDataSet);
  dirItemCount = dirDataSet.children(dirListItem).length;

  dirDataSet.children(dirListItem).each(function (i, el) {
    $(dirItemsList).append($(el).clone(true));
  });

  loadPagination(1, $(dirItemsList), $(".pagination"));
  loadViewCount(1, $(dirItemsList).children(dirListItem).length);
  runMatchHeight();
}

function loadViewCount(page, total) {
  var start = (page - 1) * itemsPerPage + 1;
  var end = (page * itemsPerPage > dirItemCount) ? dirItemCount : page * itemsPerPage;

  if (itemsPerPage != "All") {
    document.getElementById("view-count").innerHTML = "Viewing: " + start + "-" + end + " of " + dirItemCount + " results";
  }
}

function loadPagination(page, container, pagination) {
  var totalItems = dirItemCount;
  var start = page * itemsPerPage - itemsPerPage;
  var end = start + itemsPerPage - 1;
  if (end > totalItems) end = totalItems;

  container.children(dirListItem).each(function (i, el) {
    $(el).hide();
    if (i >= start && i <= end) {
      $(el).show();
    }
  });

  var totalPages = Math.floor(totalItems / itemsPerPage) + 1;
  if (totalItems % itemsPerPage == 0) totalPages--;

  pagination.empty();

  if (totalPages > 1) {
    if (dirCurrentPage > 1) {
      pagination.append('<li class="first"><a href="javascript:pager(1)"><span aria-hidden="true"><<</span><div class="sr-only">First</div></a></li>');
      pagination.append('<li class="previous"><a href="javascript:pager(' + (dirCurrentPage - 1) + ')"><span aria-hidden="true"><</span><div class="sr-only">Previous</div></a></li>');
    } else {
      pagination.append('<li class="first disabled"><span aria-hidden="true"><<</span><div class="sr-only">First (Disabled)</div></li>');
      pagination.append('<li class="previous disabled"><span aria-hidden="true"><</span><div class="sr-only">Previous (Disabled)</div></li>');
    }

    if (totalPages > 6) {
      var offSet = page == 1 ? 1 : 0;
      var p1Num = offSet + (dirCurrentPage - 1 < totalPages - 5 ? dirCurrentPage - 1 : totalPages - 5);
      var p2Num = offSet + (dirCurrentPage + 0 < totalPages - 4 ? dirCurrentPage + 0 : totalPages - 4);
      var p3Num = offSet + (dirCurrentPage + 1 < totalPages - 3 ? dirCurrentPage + 1 : totalPages - 3);

      pagination.append(getPageLink(p1Num, page));
      pagination.append(getPageLink(p2Num, page));
      pagination.append(getPageLink(p3Num, page));

      pagination.append(getPageLink(totalPages - 2, page));
      pagination.append(getPageLink(totalPages - 1, page));
      pagination.append(getPageLink(totalPages, page));
    } else {
      for (var i = 0; i < totalPages; i++) {
        pagination.append(getPageLink(i + 1, page));
      }
    }

    if (dirCurrentPage < totalPages) {
      pagination.append('<li class="next"><a href="javascript:pager(' + (dirCurrentPage + 1) + ')"><span aria-hidden="true">></span><span class="sr-only">Next</span></a></li>');
      pagination.append('<li class="last"><a href="javascript:pager(' + totalPages + ')"><span aria-hidden="true">>></span><span class="sr-only">Last</span></a></li>');
    } else {
      pagination.append('<li class="next disabled"><span aria-hidden="true">></span><div class="sr-only">Next (Disabled)</div></li>');
      pagination.append('<li class="last disabled"><span aria-hidden="true">>></span><div class="sr-only">Last (Disabled)</div></li>');
    }
  }

  runMatchHeight();
}

function getPageLink(number, currentPage) {
  var activeClass = number == currentPage ? 'class="active"' : "";
  return "<li " + activeClass + '><a href="javascript:pager(' + number + ')">' + number + "</a></li>";
}

function pager(page) {
  if (page < 1) page = 1;
  dirCurrentPage = page;
  loadPagination(page, $(dirItemsList), $(".pagination"));
  loadViewCount(page, $(dirItemsList));
}

// Setup initial variables
var dirDataSet,
  dirItemCount = 0,
  dirCurrentPage = 1,
  dirItemsList = ".dirItems",
  dirListItem = ".filter-match",
  dirContent = "",
  dirNames = [],
  dirTags = [],
  dirTitles = [],
  dirImage = "",
  dirImageAlt = "",
  allChoices = [],
  departments = [],
  departmentSelect = "",
  departmentSelectOptions = "",
  categoryClass = "",
  textSearch = "";

Array.prototype.contains = function (obj) {
  for (var i = this.length; i--;) {
    if (this[i] === obj) return true;
  }
  return false;
};

// Column layout setup
if (listType == "classic" || listType == "tiles") {
  var columnSpan = "col-sm-6 col-md-4 col-lg-3";
  var rowColumnOneSpan = "12";
  var rowColumnTwoSpan = "12";
} else if (listType == "list") {
  columnSpan = "col-sm-12 col-md-6";
  if (imgPosition == "left") {
    rowColumnOneSpan = "4";
    rowColumnTwoSpan = "8";
  } else {
    rowColumnOneSpan = "8";
    rowColumnTwoSpan = "4";
  }
}

// AJAX request
$.ajax({
  dataType: "json",
  async: false,
  url: jsonFeed,
  success: function (data) {
    faculty = sortByKeyAsc(data.faculty, dirSort);

    for (var i = 0; i < faculty.length; ++i) {
      var person = faculty[i];
      dirNames.push(person.fullName);

      var anchor = person.fullName.replace(/[^0-9a-z]/gi, "").toLowerCase();

      var tags = person.tags || [];
      $.each(tags, function (i, tag) {
        if ($.inArray(tag, dirTags) < 0) dirTags.push(tag);
      });
      var tagString = tags.length > 0 ? tags.join(", ") : "none added";

      if ($.inArray(person.title, dirTitles) < 0) dirTitles.push(person.title);

      var departmentsList = person.departments;
      $.each(departmentsList, function (i, dept) {
        if ($.inArray(dept, departments) < 0) departments.push(dept);
      });

      var departmentText = departmentsList.join(", ");
      var departmentClass = departmentText.replace(/, /g, "ANDDIR").replace(/[^0-9a-z]/gi, "").replace(/ANDDIR/g, " ").toLowerCase();

      var imageSrc = person.headshot ? person.headshot : defaultImage;
      var imageAlt = person.headshot ? person.firstName + " " + person.lastName + "'s Photo" : "";

      var card = '<div id="' + anchor + '" class="' + columnSpan + ' dirItem filter-match ' + imageType + ' all ' + departmentClass + '" data-first-name="' + person.firstName + '" data-last-name="' + person.lastName + '">';
      card += '<div class="card panel-' + listType + ' ' + imgPosition + '-image">';
      card += '<div class="panel-body">';

      if (listType == "list" || listType == "tiles") {
        card += '<div class="row this">';

        if (imgPosition == "left" || listType == "tiles") {
          if (imageType == "blockImage") {
            card += '<div class="panel-image col-sm-' + rowColumnOneSpan + ' text-center">';
            card += '<img src="' + imageSrc + '" class="img-responsive" alt="' + imageAlt + '"';
            if (listType == "tiles") card += ' style="height:' + imageHeight + ';"';
            card += ' />';
          } else {
            card += '<div class="col-sm-' + rowColumnOneSpan + ' text-center panel-image" style="background-image:url(' + imageSrc + ');';
            if (listType == "tiles") card += ' height:' + imageHeight + ';';
            card += '">';
          }
          card += '</div>';
        }

        if (imgPosition == "left" || listType == "tiles") {
          card += '<div class="card__content col-sm-' + rowColumnTwoSpan + '">';
        } else if (imgPosition == "right") {
          card += '<div class="card__content col-sm-' + rowColumnOneSpan + '">';
        }
      }

      card += '<div class="card__title"><p class="h5"><a href="' + person.link + '" target="_parent">' + person.firstName + " " + person.lastName + "</a></p></div>";
      card += '<div class="panel-text">';
      card += '<div class="depts">' + person.title + "</div>";
      card += "<div>" + departmentText + "</div>";
      card += '<div class="card__meta">';
      if (person.email) {
        card += '<div class="email"><b>Email:</b> <span><a href="mailto:' + person.email + '">' + person.email + "</a></span></div>";
      }
      if (person.phone) {
        card += '<div class="phone"><b>Phone:</b> <span><a href="tel:' + person.phone + '">' + person.phone + "</a></span></div>";
      }
      if (person.office) {
        card += '<div class="office"><b>Office:</b> <span><a href="https://maps.google.com/?q=' + person.office + '" target="_blank">' + person.office + "</a></span></div>";
      }
      card += "</div>";
      card += "</div>";

      if (listType == "list" || listType == "tiles") {
        card += "</div>";

        if (listType == "list" && imgPosition == "right") {
          if (imageType == "blockImage") {
            card += '<div class="panel-image col-sm-' + rowColumnTwoSpan + ' text-center">';
            card += '<img src="' + imageSrc + '" class="img-responsive" alt="' + imageAlt + '" />';
            card += "</div>";
          } else {
            card += '<div class="col-sm-' + rowColumnTwoSpan + ' text-center panel-image" style="background-image:url(' + imageSrc + ');">';
          }
          card += "</div>";
        }
        card += "</div>";
      }

      if (tagsLabel) {
        card += '<div class="panel-footer">';
        card += "<small><strong>" + tagsLabel + ':</strong> <span class="tags">' + tagString + "</span></small>";
        card += "</div>";
      }

      card += "</div></div></div>";

      dirContent += card;
    }

    $(".dirItems").html(dirContent);

    showPagination();
    var departmentsSorted = departments.sort();
    departmentSelect += '<option value="all">All</option>';
    $.each(departmentsSorted, function (i, dept) {
      departmentSelectOptions = '<option value="' + dept.replace(/[^0-9a-z]/gi, "").toLowerCase() + '">' + dept + "</option>";
      departmentSelect += departmentSelectOptions;
    });
    $("#dirDept").html(departmentSelect);
    runMatchHeight();
    allChoices = dirNames.concat(dirTitles, dirTags);
  },
  error: function (e) {
    console.log(e.message, "this is a NEW message");
  }
});

$("#searchDir").on("keyup", function () {
  $(".dirItem").removeClass("filter-match");
  dirDeptSearch("text");
  search();
  checkResults();
  showPagination();
  runMatchHeight();
});

$("#dirDept").change(function () {
  $(".dirItem").addClass("filter-match");
  search();
  dirDeptSearch();
  checkResults();
  showPagination();
  runMatchHeight();
});

$("#searchDir").autoComplete({
  minChars: 1,
  source: function (term, suggest) {
    term = term.toLowerCase();
    var matches = [];
    for (var i = 0; i < allChoices.length; i++) {
      if (~allChoices[i].toLowerCase().indexOf(term)) {
        matches.push(allChoices[i]);
      }
    }
    suggest(matches);
  },
  menuClass: "hh-directory hh-module",
  onSelect: function (e, term, item) {
    $(".dirItem").removeClass("filter-match");
    dirDeptSearch("text");
    search();
    checkResults();
    showPagination();
    runMatchHeight();
  }
});
