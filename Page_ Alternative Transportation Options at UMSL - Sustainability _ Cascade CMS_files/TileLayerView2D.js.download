// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.32/esri/copyright.txt for details.
//>>built
require({cache:{"esri/views/2d/layers/BitmapTileLayerView2D":function(){define("exports ../../../chunks/tslib.es6 ../../../core/Logger ../../../core/has ../../../core/RandomLCG ../../../core/Error ../../../core/accessorSupport/decorators/subclass ../engine/BitmapTileContainer".split(" "),function(d,g,a,b,f,e,c,l){d.BitmapTileLayerView2D=m=>{m=class extends m{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`);this._bitmapView=new l.BitmapTileContainer(this._tileInfoView);
this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView);this._bitmapView?.removeAllChildren();this._bitmapView=null}};return m=g.__decorate([c.subclass("esri.views.2d.layers.BitmapTileLayerView2D")],m)};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/LayerView2D":function(){define("exports ../../../chunks/tslib.es6 ../../../core/Collection ../../../core/collectionUtils ../../../core/Error ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../linkChart/utils ../engine/Container ./support/HighlightCounter ./support/util ../support/highlightOptionsUtils ../../layers/support/ClipRect ../../layers/support/Geometry ../../layers/support/Path ../../support/HighlightOptions ../../support/layerViewUtils".split(" "),
function(d,g,a,b,f,e,c,l,m,k,h,n,q,D,B,E,Q,L,V,O,P){const U=a.ofType({key:"type",base:null,typeMap:{rect:Q,path:V,geometry:L}}),R=new (a.ofType(O));d.LayerView2DMixin=w=>{w=class extends w{constructor(){super(...arguments);this._highlightCounter=new D.HighlightCounter;this.attached=!1;this.clips=new U;this.highlights=null;this.lastUpdateId=-1;this.updateRequested=this.moving=!1;this._visibleAtCurrentScale=!0}initialize(){const y=this.view?.spatialReferenceLocked??!0;this.view?.spatialReference&&y&&
!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new f("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new q.Container),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([e.watch(()=>this.suspended,r=>{this.container&&(this.container.visible=!r)},e.syncAndInitial),e.watch(()=>this.updateSuspended,
r=>{this.view&&!r&&this.updateRequested&&this.view.requestUpdate()},e.syncAndInitial),e.watch(()=>this.layer?.opacity??1,r=>{this.container&&(this.container.opacity=r)},e.syncAndInitial),e.watch(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",r=>{this.container&&(this.container.blendMode=r)},e.syncAndInitial),e.watch(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,r=>{this.container&&(this.container.effect=r)},e.syncAndInitial),e.watch(()=>this._mergedHighlights.items.map(r=>
({name:r.name,options:{fillColor:r.color,haloColor:r.haloColor,fillOpacity:r.fillOpacity,haloOpacity:r.haloOpacity,haloWidth:r.haloWidth,haloBlur:r.haloBlur}})),()=>{this.container.highlightGradient=B.createOrReuseHighlightGradient(this.container.highlightGradient,this._mergedHighlights.items)},e.syncAndInitial),e.watch(()=>this._mergedHighlights.items.map(r=>r.name),()=>{this._processHighlight()}),e.on(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},e.syncAndInitial),
e.watch(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:r,scaleRange:M})=>{r=P.isInEffectiveScaleRange(M,r);r!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=r)},e.syncAndInitial)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(r=>{r===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach();this.updateRequested=
!1}get highlightOptions(){return E.getDefaultHighlightOptions(this)}set highlightOptions(y){E.setDefaultHighlightOptions(this,y)}get hasHighlight(){return 0<this._highlightCounter.size}get _mergedHighlights(){if(!this.view)return R;if(!this.highlights)return this.view.highlights;const y=this.view.highlights.clone();for(const r of this.highlights){const M=y.find(W=>W.name===r.name);M&&M.assignFrom(r)}return y}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){const y=
this.view?.spatialReference;return null==y||this.supportsSpatialReference(y)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&
(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(y){this.isFulfilled()&&!this.isResolved()?this.updateRequested=!1:(this._set("updateParameters",y),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(y)))}hitTest(y,r){return Promise.resolve(null)}supportsSpatialReference(y){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;
switch(this.layer?.type){case "link-chart":case "knowledge-graph-sublayer":case "graphics":break;default:if(n.isLinkChartView(this.view)&&!this.view.inGeographicLayout)return!1}return super.canResume()?this.visibleAtCurrentScale:!1}getSuspendInfo(){const y=super.getSuspendInfo(),r=!this.spatialReferenceSupported;r&&(y.spatialReferenceNotSupported=r);return y}addAttachHandles(y){this.addHandles(y,"attach")}_addHighlights(y,r){this._highlightCounter.add(y,r)&&this._processHighlight()}_removeHighlights(y,
r){this._highlightCounter.delete(y,r)&&this._processHighlight()}_processHighlight(){}_getHighlights(){const y=[];for(const [r,M]of this._highlightCounter.highlightNamesByObjectId){const W=this._getHighlightBits(M);y.push({objectId:r,highlightFlags:W})}return y}_getHighlightBits(y){y=new Set(y);let r=1,M=0;if(!this.view)return 0;const W=this._mergedHighlights;for(const {name:Y}of W)y.delete(Y)&&(M=r),r<<=1;return M}};g.__decorate([c.property()],w.prototype,"attached",void 0);g.__decorate([c.property({type:U,
set(y){y=b.referenceSetter(y,this._get("clips"),U);this._set("clips",y)}})],w.prototype,"clips",void 0);g.__decorate([c.property()],w.prototype,"container",void 0);g.__decorate([c.property({type:O})],w.prototype,"highlightOptions",null);g.__decorate([c.property({type:a.ofType(O)})],w.prototype,"highlights",void 0);g.__decorate([c.property()],w.prototype,"_mergedHighlights",null);g.__decorate([c.property()],w.prototype,"moving",void 0);g.__decorate([c.property({readOnly:!0})],w.prototype,"spatialReferenceSupported",
null);g.__decorate([c.property({readOnly:!0})],w.prototype,"updateParameters",void 0);g.__decorate([c.property()],w.prototype,"updateRequested",void 0);g.__decorate([c.property()],w.prototype,"updating",null);g.__decorate([c.property()],w.prototype,"view",void 0);g.__decorate([c.property()],w.prototype,"_visibleAtCurrentScale",void 0);g.__decorate([c.property({readOnly:!0})],w.prototype,"visibleAtCurrentScale",null);return w=g.__decorate([h.subclass("esri.views.2d.layers.LayerView2D")],w)};Object.defineProperty(d,
Symbol.toStringTag,{value:"Module"})})},"esri/linkChart/utils":function(){define(["exports"],function(d){d.isLinkChartView=function(g){return null!=g&&"object"===typeof g&&"2d"===g.type&&"linkchart"===g.view2dType};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/views/2d/layers/support/HighlightCounter":function(){define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/ReactiveMap ../../../../core/Logger ../../../../core/has ../../../../core/RandomLCG ../../../../core/Error ../../../../core/accessorSupport/decorators/subclass".split(" "),
function(d,g,a,b,f,e,c,l,m,k){function*h(n){for(const [q,D]of n)yield[q,D.keys()]}d.HighlightCounter=class extends a{constructor(){super(...arguments);this._idToCounters=new f}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return h(this._idToCounters)}add(n,q){let D=!1;for(const B of n){n=b.getOrCreateMapValue(this._idToCounters,B,()=>{D=!0;return new Map});const E=n.get(q)??0;E||(D=!0);n.set(q,E+1)}return D}delete(n,q){let D=
!1;for(const B of n){n=this._idToCounters.get(B);if(!n)continue;let E=n.get(q);null!=E&&(E--,0<E?n.set(q,E):(n.delete(q),D=!0),0===n.size&&(this._idToCounters.delete(B),D=!0))}return D}};d.HighlightCounter=g.__decorate([k.subclass("esri.views.2d.layers.support.HighlightCounter")],d.HighlightCounter);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/support/ClipRect":function(){define("../../../chunks/tslib.es6 ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ./ClipArea".split(" "),
function(d,g,a,b,f,e,c){var l;a=l=class extends c{constructor(m){super(m);this.type="rect";this.bottom=this.top=this.right=this.left=null}clone(){return new l({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left");this.commitProperty("right");this.commitProperty("top");this.commitProperty("bottom")}};d.__decorate([g.property({type:[Number,String],json:{write:!0}})],a.prototype,"left",void 0);d.__decorate([g.property({type:[Number,String],
json:{write:!0}})],a.prototype,"right",void 0);d.__decorate([g.property({type:[Number,String],json:{write:!0}})],a.prototype,"top",void 0);d.__decorate([g.property({type:[Number,String],json:{write:!0}})],a.prototype,"bottom",void 0);return a=l=d.__decorate([e.subclass("esri.views.layers.support.ClipRect")],a)})},"esri/views/layers/support/ClipArea":function(){define("../../../chunks/tslib.es6 ../../../core/JSONSupport ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass".split(" "),
function(d,g,a,b,f,e,c){g=class extends g{get version(){this.commitVersionProperties();return(this._get("version")||0)+1}};d.__decorate([a.property({readOnly:!0})],g.prototype,"version",null);return g=d.__decorate([c.subclass("esri.views.layers.support.ClipArea")],g)})},"esri/views/layers/support/Geometry":function(){define("../../../chunks/tslib.es6 ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Polygon ../../../geometry/support/jsonUtils ./ClipArea".split(" "),
function(d,g,a,b,f,e,c,l,m,k,h){var n;a={base:l,key:"type",typeMap:{extent:c,polygon:m}};h=n=class extends h{constructor(q){super(q);this.type="geometry";this.geometry=null}clone(){return new n({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};d.__decorate([g.property({types:a,json:{read:k.fromJSON,write:!0}})],h.prototype,"geometry",void 0);return h=n=d.__decorate([e.subclass("esri.views.layers.support.Geometry")],h)})},"esri/views/layers/support/Path":function(){define("../../../chunks/tslib.es6 ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ./ClipArea".split(" "),
function(d,g,a,b,f,e,c){a=class extends c{constructor(l){super(l);this.type="path";this.path=[]}commitVersionProperties(){this.commitProperty("path")}};d.__decorate([g.property({type:[[[Number]]],json:{write:!0}})],a.prototype,"path",void 0);return a=d.__decorate([e.subclass("esri.views.layers.support.Path")],a)})},"esri/views/2d/layers/graphics/HighlightGraphicContainer":function(){define("../../../../chunks/tslib.es6 ../../../../core/Logger ../../../../core/has ../../../../core/RandomLCG ../../../../core/Error ../../../../core/accessorSupport/decorators/subclass ../../engine/webgl/enums ./AGraphicContainer ../support/util".split(" "),
function(d,g,a,b,f,e,c,l,m){g=class extends l.AGraphicContainer{get hasHighlight(){return this.children.some(k=>k.hasData)}renderChildren(k){this.attributeView.update();k.drawPhase===c.WGLDrawPhase.HIGHLIGHT&&this.children.some(h=>h.hasData)&&(super.renderChildren(k),k.context.setColorMask(!0,!0,!0,!0),m.renderHighlight(k,!1,h=>{this._renderChildren(h,c.FeatureSelection.Highlight)}))}};return g=d.__decorate([e.subclass("esri.views.2d.layers.graphics.HighlightGraphicContainer")],g)})},"esri/views/2d/layers/support/imageUtils":function(){define(["exports"],
function(d){function g(a){const b=document.createElement("canvas");[b.width,b.height]=a;return b}d.createBlankImage=g;d.resampleImage=function(a,b,f,e){if(f.level===e.level)return b;const c=a.tileInfo.size;var l=a.getTileResolution(f.level),m=a.getTileResolution(e.level),k=a.getLODInfoAt(e.level),h=k.getXForColumn(e.col);e=k.getYForRow(e.row);k=a.getLODInfoAt(f.level);a=k.getXForColumn(f.col);const n=k.getYForRow(f.row);k=(b instanceof HTMLImageElement?b.naturalWidth:b.width)/c[0];f=(b instanceof
HTMLImageElement?b.naturalHeight:b.height)/c[1];h=Math.round((h-a)/l*k);e=Math.round(-(e-n)/l*f);a=Math.round(m/l*c[0]*k);l=Math.round(m/l*c[1]*f);m=g(c);m.getContext("2d").drawImage(b,h,e,a,l,0,0,c[0],c[1]);return m};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/views/layers/RefreshableLayerView":function(){define("../../chunks/tslib.es6 ../../core/Logger ../../core/promiseUtils ../../core/reactiveUtils ../../core/has ../../core/RandomLCG ../../core/Error ../../core/accessorSupport/decorators/subclass".split(" "),
function(d,g,a,b,f,e,c,l){return m=>{m=class extends m{initialize(){this.addHandles(b.on(()=>this.layer,"refresh",k=>{this.doRefresh(k.dataChanged).catch(h=>{a.isAbortError(h)||g.getLogger(this).error(h)})}),"RefreshableLayerView")}};return m=d.__decorate([l.subclass("esri.views.layers.RefreshableLayerView")],m)}})},"esri/views/layers/support/MapServiceLayerViewHelper":function(){define("require exports ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/arrayUtils ../../../core/Error ../../../core/has ../../../core/MapUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/sql ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/scaleUtils ../../../layers/support/fieldUtils ../../../layers/support/floorFilterUtils ../../../renderers/support/clickToleranceUtils ../../../rest/identify ../../../rest/support/IdentifyParameters ../../../support/arcadeOnDemand ../../../symbols/SimpleMarkerSymbol ./popupUtils".split(" "),
function(d,g,a,b,f,e,c,l,m,k,h,n,q,D,B,E,Q,L,V,O,P,U,R,w,y){function r(x,u,z){const F=[];if(!x)return F;const A=v=>{var t=0===v.minScale||u<=v.minScale;const G=0===v.maxScale||u>=v.maxScale;v.visible&&t&&G&&(v.sublayers?v.sublayers.forEach(A):v.popupEnabled&&(t=y.getFetchPopupTemplate(v,{...z,defaultPopupTemplateEnabled:!1}),null!=t&&F.unshift({sublayer:v,popupTemplate:t})))};x.map(A);return F}function M(x){return x.expressionInfos?.length||Array.isArray(x.content)&&x.content.some(u=>"expression"===
u.type)?R.loadArcade():Promise.resolve()}async function W(x,u){if(x.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(u.map(({sublayer:z})=>z.load().then(()=>z.capabilities.operations.supportsQuery)))}catch{return!1}}async function Y(x,u,z){const F=x.renderer;F&&"defaultSymbol"in F&&!F.defaultSymbol&&(u=F.valueExpression?await Promise.all(u.map(A=>F.getSymbolAsync(A,z).then(v=>v?A:null))).then(A=>A.filter(v=>null!=v)):u.filter(A=>null!=F.getSymbol(A)));return u}let Z=null;
g.MapServiceLayerViewHelper=class extends b{constructor(x){super(x);this._featuresResolutions=new WeakMap;this.highlightGraphicUpdated=this.highlightGraphics=null;this.updateHighlightedFeatures=m.debounce(async u=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(u).catch(()=>{}))})}initialize(){const x=u=>{for(const z of u){const {sourceLayer:F}=z;null!=F&&"geometryType"in F&&"point"===F.geometryType&&(z.visible=!1)}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(u).catch(()=>
{}));this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([k.on(()=>this.highlightGraphics,"change",u=>x(u.added),{onListenerAdd:u=>x(u)})])}async fetchPopupFeaturesAtLocation(x,u){const {layerView:{layer:z,view:{scale:F}}}=this;if(!x)throw new e("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:z});const A=r(z.sublayers,F,u);if(!A.length)return[];const v=await W(z,A);if(!((z.capabilities?.operations?.supportsIdentify??!0)&&10.5<=z.version||v))throw new e("fetchPopupFeatures:not-supported",
"query operation is disabled for this service",{layer:z});return v?this._fetchPopupFeaturesUsingQueries(x,A,u):this._fetchPopupFeaturesUsingIdentify(x,A,u)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(x){const {layerView:{view:u},highlightGraphics:z,highlightGraphicUpdated:F}=this;if(z&&F)for(const A of x){const v=A.sourceLayer&&"renderer"in A.sourceLayer&&A.sourceLayer.renderer;A.sourceLayer&&"geometryType"in A.sourceLayer&&"point"===A.sourceLayer.geometryType&&
v&&"getSymbolAsync"in v&&v.getSymbolAsync(A).then(async t=>{t||=new w;let G=null;const H="visualVariables"in v?v.visualVariables?.find(I=>"size"===I.type):void 0;H&&(Z||(Z=(await new Promise((I,K)=>d(["../../../renderers/visualVariables/support/visualVariableUtils"],I,K))).getSize),G=Z(H,A,{view:u.type,scale:u.scale,shape:"simple-marker"===t.type?t.style:null}));G||="width"in t&&"height"in t&&null!=t.width&&null!=t.height?Math.max(t.width,t.height):"size"in t?t.size:16;z.includes(A)&&(A.symbol=new w({style:"square",
size:G,xoffset:"xoffset"in t?t.xoffset:0,yoffset:"yoffset"in t?t.yoffset:0}),F(A,"symbol"),A.visible=!0)})}}async _updateHighlightedFeaturesGeometries(x){const {layerView:{layer:u,view:z},highlightGraphics:F,highlightGraphicUpdated:A}=this;this._highlightGeometriesResolution=x;if(A&&F?.length&&u.capabilities.operations.supportsQuery){var v=this._getTargetResolution(x);x=new Map;for(var t of F)(!this._featuresResolutions.has(t)||this._featuresResolutions.get(t)>v)&&l.getOrCreateMapValue(x,t.sourceLayer,
()=>new Map).set(t.getObjectId(),t);t=Array.from(x,([G,H])=>{const I=G.createQuery();I.objectIds=[...H.keys()];I.outFields=[G.objectIdField];I.returnGeometry=!0;I.maxAllowableOffset=v;I.outSpatialReference=z.spatialReference;return G.queryFeatures(I)});t=await Promise.all(t);if(!this.destroyed)for(const {features:G}of t)for(const H of G)(t=x.get(H.sourceLayer).get(H.getObjectId()))&&F.includes(t)&&(t.geometry=H.geometry,A(t,"geometry"),this._featuresResolutions.set(t,v))}}_getTargetResolution(x){const u=
x*n.getMetersPerUnitForSR(this.layerView.view.spatialReference),z=u/16;return 10>=z?0:x/u*z}async _fetchPopupFeaturesUsingIdentify(x,u,z){x=await this._createIdentifyParameters(x,u,z);if(null==x)return[];({results:z}=await P.identify(this.layerView.layer.parsedUrl,x,z));return z.map(F=>F.feature)}async _createIdentifyParameters(x,u,z){const {floors:F,layer:A,timeExtent:v,view:{spatialReference:t,scale:G}}=this.layerView;if(!u.length)return null;await Promise.all(u.map(({sublayer:S})=>S.load(z).catch(()=>
{})));u=Math.min(c("mapservice-popup-identify-max-tolerance"),A.allSublayers.reduce((S,ba)=>ba.renderer?O.calculateTolerance({renderer:ba.renderer,pointerType:z?.pointerType}):S,2));var H=this.createFetchPopupFeaturesQueryGeometry(x,u);const I=Q.getResolutionForScale(G,t),K=Math.round(H.width/I);H=new E({xmin:H.center.x-I*K,ymin:H.center.y-I*K,xmax:H.center.x+I*K,ymax:H.center.y+I*K,spatialReference:H.spatialReference});return new U({floors:F,gdbVersion:"gdbVersion"in A?A.gdbVersion:void 0,geometry:x,
height:K,layerOption:"popup",mapExtent:H,returnGeometry:!0,spatialReference:t,sublayers:A.sublayers,timeExtent:v,tolerance:u,width:K})}async _fetchPopupFeaturesUsingQueries(x,u,z){const {layerView:{floors:F,timeExtent:A}}=this;u=u.map(async({sublayer:v,popupTemplate:t})=>{await v.load(z).catch(()=>{});if(v.capabilities&&!v.capabilities.operations.supportsQuery)return[];var G=v.createQuery(),H=O.calculateTolerance({renderer:v.renderer,pointerType:z?.pointerType}),I=this.createFetchPopupFeaturesQueryGeometry(x,
H),K=new Set,[S]=await Promise.all([y.getRequiredFields(v,t),v.renderer?.collectRequiredFields(K,v.fieldsIndex)]);m.throwIfAborted(z);L.collectFields(K,v.fieldsIndex,S);K=Array.from(K).sort();G.geometry=I;G.outFields=K;G.timeExtent=A;K=V.getLayerFloorFilterClause(F,v);G.where=h.sqlAnd(G.where,K);v.capabilities?.query.supportsOrderBy&&v.orderBy?.[0]&&(S=v.orderBy[0],K=!S.valueExpression&&S.field,S="ascending"===S.order?"asc":"desc",K&&(G.orderByFields=[`${K} ${S}`]));H=this._getTargetResolution(I.width/
H);I=await M(t);m.throwIfAborted(z);t="point"===v.geometryType||I&&I.arcadeUtils.hasGeometryOperations(t);t||(G.maxAllowableOffset=H);({features:G}=await v.queryFeatures(G,z));t=t?0:H;G=await Y(v,G,z);for(const ba of G)this._featuresResolutions.set(ba,t);return G});return(await Promise.allSettled(u)).reduce((v,t)=>"fulfilled"===t.status?[...v,...t.value]:v,[]).filter(f.isSome)}};a.__decorate([q.property({constructOnly:!0})],g.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",
void 0);a.__decorate([q.property({constructOnly:!0})],g.MapServiceLayerViewHelper.prototype,"layerView",void 0);a.__decorate([q.property({constructOnly:!0})],g.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0);a.__decorate([q.property({constructOnly:!0})],g.MapServiceLayerViewHelper.prototype,"highlightGraphicUpdated",void 0);a.__decorate([q.property({constructOnly:!0})],g.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0);g.MapServiceLayerViewHelper=a.__decorate([B.subclass("esri.views.layers.support.MapServiceLayerViewHelper")],
g.MapServiceLayerViewHelper);g.collectPopupProviders=r;g.isMapServiceLayerView=function(x,u){return"tile"===u.type||"map-image"===u.type};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/floorFilterUtils":function(){define(["exports"],function(d){function g(a,b){if(!a?.length)return null;a=a.filter(f=>""!==f).map(f=>`'${f}'`);a.push("''");return`${b} IN (${a.join(",")}) OR ${b} IS NULL`}d.getFloorFilterClause=function(a){const b=a.layer;return"floorInfo"in b&&b.floorInfo?.floorField&&
"floors"in a.view?g(a.view.floors,b.floorInfo.floorField):null};d.getLayerFloorFilterClause=function(a,b){return"floorInfo"in b&&b.floorInfo?.floorField?g(a,b.floorInfo.floorField):null};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/renderers/support/clickToleranceUtils":function(){define(["exports"],function(d){function g(f,e){return e?"xoffset"in e&&e.xoffset?Math.max(f,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(f,Math.abs(e.yoffset||0)):f:f}function a(f,e){if("number"===
typeof f)return f;if(f?.stops?.length){f=f.stops;let c=e=0;for(let l=0;l<f.length;l++){const m=f[l].size;"number"===typeof m&&(e+=m,c++)}return e/c}return e}function b(f,e){if(!e)return f;e=e.filter(m=>"size"===m.type).map(m=>{const {maxSize:k,minSize:h}=m;return(a(k,f)+a(h,f))/2});let c=0;const l=e.length;if(0===l)return f;for(let m=0;m<l;m++)c+=e[m];return Math.max(Math.floor(c/l),f)}d.calculateTolerance=function(f){const e=f?.renderer;f="touch"===f?.pointerType?9:6;if(!e)return f;f="visualVariables"in
e?b(f,e.visualVariables):f;if("simple"===e.type)return g(f,e.symbol);if("unique-value"===e.type){let c=f;e.uniqueValueInfos?.forEach(l=>{c=g(c,l.symbol)});return c}if("class-breaks"===e.type){let c=f;e.classBreakInfos.forEach(l=>{c=g(c,l.symbol)});return c}return f};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/rest/identify":function(){define("exports ../request ../geometry/support/normalizeUtils ./utils ./operations/identify ./support/IdentifyParameters ./support/IdentifyResult".split(" "),
function(d,g,a,b,f,e,c){function l(h){h=h.data;h.results=h.results||[];h.exceededTransferLimit=!!h.exceededTransferLimit;h.results=h.results.map(n=>c.fromJSON(n));return h}function m(h){return h=e.from(h)}function k(h,n){function q(B){D.set(B.id,B);B.sublayers&&B.sublayers.forEach(q)}if(!n?.length)return h;const D=new Map;n.forEach(q);for(const B of h.results)B.feature.sourceLayer=D.get(B.layerId);return h}d.identify=async function(h,n,q){n=m(n);const D=n.geometry?[n.geometry]:[],B=b.parseUrl(h);
B.path+="/identify";return a.normalizeCentralMeridian(D).then(E=>{E=f.identifyToIdentifyRESTParameters(n,{geometry:E?.[0]});E=b.encode({...B.query,f:"json",...E});E=b.asValidOptions(E,q);return g(B.path,E).then(l).then(Q=>k(Q,n.sublayers))})};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/rest/operations/identify":function(){define("exports ../../core/sql ../../geometry/support/jsonUtils ../../geometry/support/scaleUtils ../../geometry/support/spatialReferenceUtils ../../layers/support/floorFilterUtils ../../layers/support/sublayerUtils".split(" "),
function(d,g,a,b,f,e,c){function l(k){const {mapExtent:h,floors:n,width:q,sublayers:D,layerIds:B,layerOption:E,gdbVersion:Q}=k;var L=D?.find(w=>null!=w.layer)?.layer?.serviceSublayers;const V="popup"===E;k={};const O=b.getScale({extent:h,width:q,spatialReference:h?.spatialReference}),P=[],U=w=>{const y=0===O,r=0===w.minScale||O<=w.minScale,M=0===w.maxScale||O>=w.maxScale;w.visible&&(y||r&&M)&&(w.sublayers?w.sublayers.forEach(U):!1!==B?.includes(w.id)&&(!V||w.popupTemplate&&w.popupEnabled)&&P.unshift(w))};
D?.forEach(U);if(D&&!P.length)k.layerIds=[];else{L=c.isExportDynamic(P,L,Q);var R=P.map(w=>{const y=e.getLayerFloorFilterClause(n,w);return w.toExportImageJSON(y)});if(L)k.dynamicLayers=JSON.stringify(R);else if(D?(L=P.map(({id:w})=>w),B&&(L=L.filter(w=>B.includes(w))),k.layerIds=L):B?.length&&(k.layerIds=B),L=m(n,P),null!=L&&L.length){R={};for(const w of L)w.definitionExpression&&(R[w.id]=w.definitionExpression);Object.keys(R).length&&(k.layerDefs=JSON.stringify(R))}}return k}function m(k,h){const n=
!!k?.length;h=h.filter(q=>null!=q.definitionExpression||n&&null!=q.floorInfo);return h.length?h.map(q=>{var D=e.getLayerFloorFilterClause(k,q);D=g.sqlAnd(D,q.definitionExpression);return{id:q.id,definitionExpression:D??void 0}}):null}d.identifyToIdentifyRESTParameters=function(k,h){const {dpi:n,gdbVersion:q,geometry:D,geometryPrecision:B,height:E,historicMoment:Q,layerOption:L,mapExtent:V,maxAllowableOffset:O,returnFieldName:P,returnGeometry:U,returnUnformattedValues:R,returnZ:w,spatialReference:y,
timeExtent:r,tolerance:M,width:W}=k.toJSON(),{dynamicLayers:Y,layerDefs:Z,layerIds:x}=l(k);k={historicMoment:Q,geometryPrecision:B,maxAllowableOffset:O,returnFieldName:P,returnGeometry:U,returnUnformattedValues:R,returnZ:w,tolerance:M};h=(null!=h?.geometry?h.geometry:null)?.toJSON()||D;k.imageDisplay=`${W},${E},${n}`;q&&(k.gdbVersion=q);h&&(delete h.spatialReference,k.geometry=JSON.stringify(h),k.geometryType=a.getJsonType(h));if(h=y??h?.spatialReference??V?.spatialReference)k.sr=f.srToRESTValue(h);
k.time=r?[r.start,r.end].join():null;if(V){const {xmin:u,ymin:z,xmax:F,ymax:A}=V;k.mapExtent=`${u},${z},${F},${A}`}Z&&(k.layerDefs=Z);Y&&!Z&&(k.dynamicLayers=Y);k.layers="popup"===L?"visible":L;x&&!Y&&(k.layers+=`:${x.join(",")}`);return k};d.toDynamicLayersJSON=l;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/layers/support/sublayerUtils":function(){define(["exports","../../core/accessorSupport/PropertyOrigin"],function(d,g){function a(b,f){if(!b?.length||null==f)return!0;
f=f.slice().reverse().flatten(({sublayers:l})=>l&&l.toArray().reverse()).map(l=>l.id).toArray();if(b.length>f.length)return!1;let e=0;const c=f.length;for(const {id:l}of b){for(;e<c&&f[e]!==l;)e++;if(e>=c)return!1}return!0}d.isExportDynamic=function(b,f,e){return b.some(c=>{var l=c.source;l=!l||"map-layer"===l.type&&l.mapLayerId===c.id&&(null==l.gdbVersion||l.gdbVersion===e);c.commitProperty("renderer");c.commitProperty("labelingInfo");c.commitProperty("opacity");c.commitProperty("labelsVisible");
c.commitProperty("orderBy");const m=c.layer?.capabilities?.exportMap?.supportsSublayerOrderBy??!1;return!l||c.originIdOf("renderer")>g.OriginId.SERVICE||c.originIdOf("labelingInfo")>g.OriginId.SERVICE||c.originIdOf("opacity")>g.OriginId.SERVICE||c.originIdOf("labelsVisible")>g.OriginId.SERVICE||m&&c.originIdOf("orderBy")>g.OriginId.SERVICE})?!0:!a(b,f)};d.isSublayerOverhaul=function(b){return!!b&&b.some(f=>null!=f.minScale||null!=f.layerDefinition?.minScale)};d.shouldWriteSublayerStructure=function(b,
f,e){return f.flatten(({sublayers:c})=>c).length!==b.length||b.some(c=>c.originIdOf("minScale")>e||c.originIdOf("maxScale")>e||c.originIdOf("renderer")>e||c.originIdOf("labelingInfo")>e||c.originIdOf("opacity")>e||c.originIdOf("labelsVisible")>e||c.originIdOf("source")>e)?!0:!a(b,f)};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/rest/support/IdentifyParameters":function(){define("../../chunks/tslib.es6 ../../core/Collection ../../core/JSONSupport ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../geometry/Extent ../../geometry/SpatialReference ../../geometry/support/jsonUtils ../../geometry/support/typeUtils ../../time/TimeExtent".split(" "),
function(d,g,a,b,f,e,c,l,m,k,h,n,q,D){var B;a=B=class extends a{static from(E){return f.ensureClass(B,E)}constructor(E){super(E);this.dpi=96;this.geometryPrecision=this.geometry=this.gdbVersion=this.floors=null;this.height=400;this.layerIds=this.historicMoment=null;this.layerOption="top";this.maxAllowableOffset=this.mapExtent=null;this.returnFieldName=!0;this.returnM=this.returnGeometry=!1;this.returnUnformattedValues=!0;this.returnZ=!1;this.tolerance=this.timeExtent=this.sublayers=this.spatialReference=
null;this.width=400}writeHistoricMoment(E,Q){Q.historicMoment=E&&E.getTime()}};d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"dpi",void 0);d.__decorate([b.property()],a.prototype,"floors",void 0);d.__decorate([b.property({type:String,json:{write:!0}})],a.prototype,"gdbVersion",void 0);d.__decorate([b.property({types:q.geometryTypes,json:{read:n.fromJSON,write:!0}})],a.prototype,"geometry",void 0);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"geometryPrecision",
void 0);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"height",void 0);d.__decorate([b.property({type:Date})],a.prototype,"historicMoment",void 0);d.__decorate([m.writer("historicMoment")],a.prototype,"writeHistoricMoment",null);d.__decorate([b.property({type:[Number],json:{write:!0}})],a.prototype,"layerIds",void 0);d.__decorate([b.property({type:["top","visible","all","popup"],json:{write:!0}})],a.prototype,"layerOption",void 0);d.__decorate([b.property({type:k,json:{write:!0}})],
a.prototype,"mapExtent",void 0);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"maxAllowableOffset",void 0);d.__decorate([b.property({type:Boolean,json:{write:!0}})],a.prototype,"returnFieldName",void 0);d.__decorate([b.property({type:Boolean,json:{write:!0}})],a.prototype,"returnGeometry",void 0);d.__decorate([b.property({type:Boolean,json:{write:!0}})],a.prototype,"returnM",void 0);d.__decorate([b.property({type:Boolean,json:{write:!0}})],a.prototype,"returnUnformattedValues",
void 0);d.__decorate([b.property({type:Boolean,json:{write:!0}})],a.prototype,"returnZ",void 0);d.__decorate([b.property({type:h,json:{write:!0}})],a.prototype,"spatialReference",void 0);d.__decorate([b.property({type:g})],a.prototype,"sublayers",void 0);d.__decorate([b.property({type:D,json:{write:!0}})],a.prototype,"timeExtent",void 0);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"tolerance",void 0);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"width",
void 0);return a=B=d.__decorate([l.subclass("esri.rest.support.IdentifyParameters")],a)})},"esri/rest/support/IdentifyResult":function(){define("../../chunks/tslib.es6 ../../Graphic ../../core/JSONSupport ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../geometry/support/typeUtils".split(" "),function(d,g,
a,b,f,e,c,l,m,k,h){a=class extends a{constructor(n){super(n);this.layerName=this.layerId=this.feature=this.displayFieldName=null}readFeature(n,q){return g.fromJSON({attributes:{...q.attributes},geometry:{...q.geometry}})}writeFeature(n,q){if(n){var {attributes:D,geometry:B}=n;D&&(q.attributes={...D});null!=B&&(q.geometry=B.toJSON(),q.geometryType=h.typeKebabDictionary.toJSON(B.type))}}};d.__decorate([b.property({type:String,json:{write:!0}})],a.prototype,"displayFieldName",void 0);d.__decorate([b.property({type:g})],
a.prototype,"feature",void 0);d.__decorate([l.reader("feature",["attributes","geometry"])],a.prototype,"readFeature",null);d.__decorate([k.writer("feature")],a.prototype,"writeFeature",null);d.__decorate([b.property({type:Number,json:{write:!0}})],a.prototype,"layerId",void 0);d.__decorate([b.property({type:String,json:{write:!0}})],a.prototype,"layerName",void 0);return a=d.__decorate([m.subclass("esri.rest.support.IdentifyResult")],a)})},"esri/views/layers/support/popupUtils":function(){define(["exports",
"../../../layers/support/fieldUtils"],function(d,g){function a(b,f){return b.popupTemplate?b.popupTemplate:null!=f&&f.defaultPopupTemplateEnabled&&null!=b.defaultPopupTemplate?b.defaultPopupTemplate:null}d.getFetchPopupTemplate=a;d.getRequiredFields=async function(b,f=b.popupTemplate){if(null==f)return[];const e=await f.getRequiredFields(b.fieldsIndex);({lastEditInfoEnabled:f}=f);const {objectIdField:c,typeIdField:l,globalIdField:m,relationships:k}=b;if(e.includes("*"))return["*"];f=f?g.getFeatureEditFields(b):
[];const h=g.fixFields(b.fieldsIndex,[...e,...f]);l&&h.push(l);h&&c&&b.fieldsIndex?.has(c)&&!h.includes(c)&&h.push(c);h&&m&&b.fieldsIndex?.has(m)&&!h.includes(m)&&h.push(m);k&&k.forEach(n=>{({keyField:n}=n);h&&n&&b.fieldsIndex?.has(n)&&!h.includes(n)&&h.push(n)});return h};d.hasPopupTemplate=function(b,f){return null!=a(b,{defaultPopupTemplateEnabled:f})};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"esri/views/support/drapedUtils":function(){define(["exports","../../core/unitUtils",
"../../geometry/Extent","../../renderers/support/clickToleranceUtils"],function(d,g,a,b){function f(c,l,m,k=new a){let h=0;if("2d"===m.type)h=l*(m.resolution??0);else if("3d"===m.type){var n=m.overlayPixelSizeInMapUnits(c),q=m.basemapSpatialReference;h=null==q||q.equals(m.spatialReference)?l*n:g.getMetersPerUnitForSR(q)/g.getMetersPerUnitForSR(m.spatialReference)}l=c.x-h;n=c.y-h;q=c.x+h;c=c.y+h;({spatialReference:m}=m);k.xmin=Math.min(l,q);k.ymin=Math.min(n,c);k.xmax=Math.max(l,q);k.ymax=Math.max(n,
c);k.spatialReference=m;return k}const e=new a;d.createQueryGeometry=f;d.intersectsDrapedGeometry=function(c,l,m){c=m.toMap(c);if(null==c)return!1;const k=b.calculateTolerance();return f(c,k,m,e).intersects(l)};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})})},"*noref":1}});
define("../../../chunks/tslib.es6 ../../../core/handleUtils ../../../core/Logger ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/spatialReferenceUtils ../../../support/GraphicsCollection ../../../core/Error ../../../core/scheduling ../../../core/accessorSupport/tracking/Flags ../../../core/colorUtils ../../../config ../../../symbols/cim/defaultCIMValues ../../../symbols/cim/enums ../../../core/floatRGBA ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Multipoint ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../engine/webgl/definitions ../engine/webgl/animations/instructions ../../../core/mathUtils ../../../symbols/Font ../../../core/ObjectPool ../../../geometry/support/Axis ../../../geometry/support/TileClipper ../../../symbols/cim/effects/EffectAddControlPoints ../../../symbols/cim/effects/EffectArrow ../../../symbols/cim/effects/EffectBuffer ../../../symbols/cim/effects/EffectControlMeasureLine ../../../symbols/cim/effects/EffectCut ../../../symbols/cim/effects/EffectDashes ../../../symbols/cim/effects/EffectDonut ../../../symbols/cim/effects/EffectJog ../../../symbols/cim/effects/EffectMove ../../../symbols/cim/effects/EffectOffset ../../../symbols/cim/effects/EffectReverse ../../../symbols/cim/effects/EffectRotate ../../../symbols/cim/effects/EffectScale ../../../symbols/cim/effects/EffectWave ../../../symbols/cim/placements/PlacementAlongLineSameSize ../../../symbols/cim/placements/PlacementAtExtremities ../../../symbols/cim/placements/PlacementAtRatioPositions ../../../symbols/cim/placements/PlacementInsidePolygon ../../../symbols/cim/placements/PlacementOnLine ../../../symbols/cim/placements/PlacementOnVertices ../../../symbols/cim/placements/PlacementPolygonCenter ../../../core/libs/gl-matrix-2/factories/vec2f32 ../engine/webgl/alignmentUtils ../../../symbols/support/defaults ../../../symbols/cim/OverrideHelper ../../../layers/effects/EffectView ../../../core/Evented ../engine/transitions/FadeTransition ../engine/webgl/enums ../../../core/libs/gl-matrix-2/factories/vec4f32 ../../webgl/enums ../engine/webgl/shaders/BackgroundPrograms ../../webgl/checkWebGLError ../engine/webgl/DefaultVertexAttributeLayouts ../engine/webgl/AFeatureTile ../engine/webgl/DisplayEntity ../engine/webgl/shaderGraph/techniques/featureTechniqueUtils ../engine/webgl/number ../engine/webgl/PooledUint32Array ../engine/webgl/shaders/TileInfoPrograms ../../webgl/Texture ../engine/vectorTiles/style/StyleDefinition ../engine/vectorTiles/enums ../engine/webgl/shaders/BitBlitPrograms ../../../request ../../../core/urlUtils ../../../core/pbf ../engine/webgl/shaders/StencilPrograms ../engine/webgl/shaderGraph/techniques/TechniqueType ../engine/webgl/shaderGraph/techniques/shaders/BlendShader ../engine/webgl/shaderGraph/techniques/shaders/OpacityShader ../engine/webgl/shaders/HighlightPrograms ../../webgl/FramebufferObject ../engine/webgl/meshing/SimpleMesh ../../webgl/GLObjectType ../engine/webgl/Profiler ../engine/webgl/shaderGraph/techniques/TechniqueRegistry ../../../Color ../engine/webgl/shaderGraph/techniques/shaders/constants ../engine/webgl/shaderGraph/techniques/dotDensity/DotDensityMeshWriter ../engine/webgl/shaderGraph/techniques/fill/ComplexFillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/ComplexOutlineFillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/FillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/GradientFillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/OutlineFillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/PatternFillMeshWriter ../engine/webgl/shaderGraph/techniques/fill/PatternOutlineFillMeshWriter ../engine/webgl/shaderGraph/techniques/heatmap/HeatmapMeshWriter ../../../geometry/support/aaBoundingBox ../engine/webgl/shaderGraph/techniques/text/TextMeshWriter ../engine/webgl/shaderGraph/techniques/line/GradientStrokeMeshWriter ../engine/webgl/shaderGraph/techniques/line/LineMeshWriter ../engine/webgl/shaderGraph/techniques/line/TexturedLineMeshWriter ../engine/webgl/shaderGraph/techniques/markers/MarkerMeshWriter ../../../arcade/ArcadeDate ../../../geometry/SpatialReference ../engine/webgl/shaderGraph/techniques/pieChart/PieChartMeshWriter ../../webgl/renderState ../../3d/webgl-engine/core/shaderModules/glsl ../../webgl/testSVGPremultipliedAlpha ../LabelManager ./graphics/GraphicsView2D ../../../core/asyncUtils ../../../core/Collection ../../../core/accessorSupport/watch ../../../core/accessorSupport/tracking/SimpleTrackingTarget ../../../chunks/earcut ../../../core/libs/gl-matrix-2/factories/vec3f32 ../../../geometry/support/normalizeUtilsCommon ../../../geometry/support/Ellipsoid ../../../kernel ./support/util ../navigation/MapViewNavigation ../../../core/support/UpdatingHandles ../engine/webgl/shaderGraph/techniques/shaders/MagnifierShader ../../../core/unitUtils ../../../geometry/ellipsoidUtils ../../../chunks/pe ../../../geometry/projection/projectors ../engine/webgl/shaderGraph/techniques/shaders/GridShader ../../../geometry/support/geodesicConstants ./BitmapTileLayerView2D ./LayerView2D ./graphics/HighlightGraphicContainer ./support/imageUtils ../tiling/TileInfoView ../tiling/TileKey ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView ../../layers/RefreshableLayerView ../../layers/support/MapServiceLayerViewHelper ../../support/drapedUtils ../../support/HighlightDefaults ../../support/Scheduler".split(" "),function(d,
g,a,b,f,e,c,l,m,k,h,n,q,D,B,E,Q,L,V,O,P,U,R,w,y,r,M,W,Y,Z,x,u,z,F,A,v,t,G,H,I,K,S,ba,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb,Fb,Gb,Hb,Ib,Jb,Kb,Lb,Mb,ja,Nb,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,ka,Wb,Xb,Yb,Zb,$b,ac,bc,cc,dc,la,ma,na,aa,oa,ea,pa,qa,ra,sa,fa,ta,ua,va){const wa=[0,0];let da=class extends sa(la.BitmapTileLayerView2D(ma.LayerView2DMixin(ra))){constructor(){super(...arguments);
this._fetchQueue=null;this._highlightGraphics=new k.GraphicsCollection;this.layer=this._tileStrategy=this._popupHighlightHelper=this._highlightView=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(p){this._fetchQueue.pause();this._fetchQueue.state=p.state;this._tileStrategy.update(p);this._fetchQueue.resume();this._highlightView?.processUpdate(p)}attach(){const p="tileServers"in
this.layer?this.layer.tileServers:null,C=this.tilemapCache;this._tileInfoView=new oa(this.layer.tileInfo,this.layer.fullExtent,C?.effectiveMinLOD,C?.effectiveMaxLOD);this._fetchQueue=new pa({tileInfoView:this._tileInfoView,concurrency:p&&10*p.length||10,process:(J,N)=>this.fetchTile(J,N),scheduler:this.scheduler,priority:va.TaskPriority.MAPVIEW_FETCH_QUEUE});this._tileStrategy=new qa({cachePolicy:"keep",resampling:this.resampling,acquireTile:J=>this.acquireTile(J),releaseTile:J=>this.releaseTile(J),
tileInfoView:this._tileInfoView});if(fa.isMapServiceLayerView(this,this.layer)){const J=this._highlightView=new ja({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new na(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container);this._popupHighlightHelper=new fa.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(N,T)=>ta.createQueryGeometry(N,T,this.view),highlightGraphics:this._highlightGraphics,
highlightGraphicUpdated:(N,T)=>{J.graphicUpdateHandler({graphic:N,property:T})},layerView:this,updatingHandles:this._updatingHandles})}this.requestUpdate();this.addAttachHandles(this._updatingHandles.add(()=>this.resampling,()=>{this.doRefresh()}));super.attach()}detach(){super.detach();this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeAllChildren();this._popupHighlightHelper?.destroy();this._highlightView?.destroy();this._fetchQueue=this._tileStrategy=this._tileInfoView=
this._popupHighlightHelper=null}async fetchPopupFeaturesAtLocation(p,C){return this._popupHighlightHelper?this._popupHighlightHelper.fetchPopupFeaturesAtLocation(p,C):[]}highlight(p,C){const J=ka.getHighlightGraphics(p);if(0===J.length)return g.makeHandle();const N=C?.name??ua.defaultHighlightName;this._addHighlightGraphics(J,N);return g.makeHandle(()=>!this.destroyed&&this._removeHighlightGraphics(J,N))}_processHighlight(){const p=this._getHighlights();this._highlightView?.setHighlight(p)}_addHighlightGraphics(p,
C){this._highlightGraphics.addMany(p);this._addHighlights(p.map(J=>J.uid),C)}_removeHighlightGraphics(p,C){this._highlightGraphics.removeMany(p);this._removeHighlights(p.map(J=>J.uid),C)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(p){return m.equals(this.layer.tileInfo?.spatialReference,p)}async doRefresh(){this.attached&&(this.suspended?(this._tileStrategy.clear(),this.requestUpdate()):(this._fetchQueue.reset(),this._tileStrategy.refresh(p=>this._updatingHandles.addPromise(this._enqueueTileFetch(p)))))}acquireTile(p){p=
this._bitmapView.createTile(p);const C=p.bitmap;[C.x,C.y]=this._tileInfoView.getTileCoords(wa,p.key);C.resolution=this._tileInfoView.getTileResolution(p.key);[C.width,C.height]=this._tileInfoView.tileInfo.size;this._updatingHandles.addPromise(this._enqueueTileFetch(p));this._bitmapView.addChild(p);this.requestUpdate();return p}releaseTile(p){this._fetchQueue.abort(p.key.id);this._bitmapView.removeChild(p);p.once("detach",()=>p.destroy());this.requestUpdate()}async fetchTile(p,C={}){return this.tilemapCache?
this._fetchTileWithTilemapCache(p,C):this._fetchTileWithoutTilemapCache(p,C)}async _fetchTileWithoutTilemapCache(p,C={}){const {signal:J,resamplingLevel:N=0}=C;try{return await this._fetchImage(p,J)}catch(X){if(b.isAbortError(X))throw X;if(!this.resampling)return aa.createBlankImage(this._tileInfoView.tileInfo.size);if(3>N){var T=this._tileInfoView.getTileParentId(p.id);if(T)return T=new ea(T),C=await this._fetchTileWithoutTilemapCache(T,{...C,resamplingLevel:N+1}),aa.resampleImage(this._tileInfoView,
C,T,p)}return aa.createBlankImage(this._tileInfoView.tileInfo.size)}}async _fetchTileWithTilemapCache(p,C={}){var J=this.tilemapCache;const {signal:N,resamplingLevel:T=0}=C,X=new ea(0,0,0,0);let ca,ha=null;try{ha=await J.fetchAvailabilityUpsample(p.level,p.row,p.col,X,{signal:N});if(!this.resampling&&X.level!==p.level)return await b.waitTick(C),aa.createBlankImage(this._tileInfoView.tileInfo.size);ca=await this._fetchImage(X,N)}catch(ia){if(b.isAbortError(ia))throw ia;if(this.resampling&&"unknown"===
ha&&3>T&&(J=this._tileInfoView.getTileParentId(p.id))){X.set(J);try{ca=await this._fetchTileWithTilemapCache(X,{...C,resamplingLevel:T+1})}catch{}}}return ca?this.resampling?aa.resampleImage(this._tileInfoView,ca,X,p):ca:aa.createBlankImage(this._tileInfoView.tileInfo.size)}async _enqueueTileFetch(p){if(!this._fetchQueue.has(p.key.id)){try{const C=await this._fetchQueue.push(p.key);p.bitmap.source=C;p.bitmap.width=this._tileInfoView.tileInfo.size[0];p.bitmap.height=this._tileInfoView.tileInfo.size[1];
p.once("attach",()=>this.requestUpdate())}catch(C){b.isAbortError(C)||a.getLogger(this).error(C)}this.requestUpdate()}}async _fetchImage(p,C){return this.layer.fetchImageBitmapTile(p.level,p.row,p.col,{signal:C})}};d.__decorate([f.property()],da.prototype,"resampling",null);d.__decorate([f.property()],da.prototype,"tilemapCache",null);return da=d.__decorate([l.subclass("esri.views.2d.layers.TileLayerView2D")],da)});