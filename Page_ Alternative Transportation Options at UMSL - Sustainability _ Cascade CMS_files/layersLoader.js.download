// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.32/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../layers/support/arcgisLayerUrl ../../layers/support/fetchService ../../layers/support/LayerLoadContext ../Portal ./jsonContext ./loadUtils ./portalItemUtils ../../renderers/support/styleUtils ../../support/requestPresets".split(" "),function(q,n,x,y,r,z,t,k,A,B,C){async function D(a,c){const b=a.instance,d=b.portalItem;if(d){var {url:e,title:g}=d,h=t.createForItemRead(d,"portal-item");if("group"===b.type)return E(b,h,a);e&&"media"!==b.type&&b.read({url:e},h);
var m=new r.LayerLoadContext;(a=await u(a,m,c))&&b.read(a,h);b.resourceReferences={portalItem:d,paths:h.readResourcePaths??[]};"subtype-group"!==b.type&&b.read({title:g},h);return B.loadStyleRenderer(b,h)}}async function E(a,c,b){const d=a.portalItem;if(a.sourceIsPortalItem){var {title:e,type:g}=d;if("Group Layer"===g){if(!A.hasTypeKeyword(d,"Map"))throw new n("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return F(a,b)}a.read({title:e},c);
return G(a,b)}}async function F(a,c){const b=a.portalItem,d=await b.fetchData("json");if(d){if(!c.populateGroupLayer)throw new n("portal:missing-populate-group-layer","Missing populate group layer");var e=t.createForItemRead(b,"web-map");a.read(d,e);await c.populateGroupLayer(a,d,{context:e});a.resourceReferences={portalItem:b,paths:e.readResourcePaths??[]}}}async function G(a,c){let b;var {portalItem:d}=a;if(d){var e=d.type,g=c.layerModuleTypeMap;if(!g)throw new n("portal:missing-layer-module-type-map",
"Layer module type map is required to construct sub layers");switch(e){case "Feature Service":b=g.FeatureLayer;break;case "Stream Service":b=g.StreamLayer;break;case "Scene Service":b=g.SceneLayer;break;case "Feature Collection":b=g.FeatureLayer;break;default:throw new n("portal:unsupported-item-type-as-group",`The item type '${e}' is not supported as a 'IGroupLayer'`);}var h=new r.LayerLoadContext,[m,f]=await Promise.all([b(),u(c,h)]);c=()=>m;if("Feature Service"===e)return e=k.getFirstLayerOrTable(f)?.customParameters,
f=d.url?await k.preprocessFSItemData(f,d.url,h):{},c=await H(f,g)||c,d=await I(d.url,{customParameters:e,loadContext:h}),await p(a,c,c,f,g,d);"Scene Service"===e&&d.url&&(f=await k.populateSceneServiceItemData(d,f,h));return 0<k.getNumLayersAndTables(f)?await p(a,c,null,f,g):await J(a,c,g)}}async function J(a,c,b){var {portalItem:d}=a;d?.url&&(d=await C.fetchArcGISServiceJSON(d.url))&&p(a,c,null,{layers:d.layers?.map(k.createSublayerData),tables:d.tables?.map(k.createSublayerData)},b)}async function p(a,
c,b,d,e,g){let h=d.layers||[];const m=d.tables||[];"Feature Collection"===a.portalItem?.type?(h.forEach((f,l)=>{f.id=l;"Table"===f?.layerDefinition?.type&&m.push(f)}),h=h.filter(f=>"Table"!==f?.layerDefinition?.type)):(h.reverse(),m.reverse());h.forEach(f=>{const l=g?.(f);if(l||!g)f=v(a,c(f),d,f,l),a.add(f)});if(m.length){const f=b?null:await e.FeatureLayer();m.forEach(l=>{const w=g?.(l);if(w||!g)l=v(a,b?b(l):f,d,l,w),a.tables.add(l)})}}function v(a,c,b,d,e){a=a.portalItem;const g={portalItem:a.clone(),
layerId:d.id};null!=d.url&&(g.url=d.url);c=new c(g);"sourceJSON"in c&&(c.sourceJSON=e);"subtype-group"!==c.type&&"catalog"!==c.type&&(c.sublayerTitleMode="service-name");"Feature Collection"===a.type&&(e={origin:"portal-item",portal:a.portal||z.getDefault()},c.read(d,e),b=b.showLegend,null!=b&&c.read({showLegend:b},e));return c}async function u(a,c,b){if(!1!==a.supportsData){a=a.instance;var d=a.portalItem;if(d){var e=null;try{e=await d.fetchData("json",b)}catch(g){}b="stream"===a.type?!1:"layerId"in
a;return b?(b=null,c=await K(d,e,c),(e?.layers||e?.tables)&&0<c&&(null==a.layerId&&(d=k.instanceTypeToLayerTypes(a.type),d=d?.length?k.getSublayersByLayerType(e,d)[0]:k.getFirstLayerOrTable(e))&&(a.layerId=d.id),b=L(e,a),"OrientedImageryLayer"===b?.layerType&&"oriented-imagery"===a.type&&a.supportedSourceTypes.add("Feature Layer"),b&&null!=e.showLegend&&(b.showLegend=e.showLegend)),1<c&&"sublayerTitleMode"in a&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name"),
b):e}}}async function K(a,c,b){if(c?.layers&&c?.tables)return k.getNumLayersAndTables(c);a=x.parse(a.url);if(!a)return 1;b=await b.fetchServiceMetadata(a.url.path,{customParameters:k.getFirstLayerOrTable(c)?.customParameters}).catch(()=>null);return(c?.layers?.length??b?.layers?.length??0)+(c?.tables?.length??b?.tables?.length??0)}function L(a,c){const {layerId:b}=c;return(a=a.layers?.find(d=>d.id===b)||a.tables?.find(d=>d.id===b))&&M(a,c)?a:null}function M(a,c){const b="layerType"in a&&a.layerType;
({type:c}=c);return"feature"===c&&b&&"ArcGISFeatureLayer"!==a.layerType||"catalog"===c&&!b||"oriented-imagery"===c&&!b||"subtype-group"===c&&!b?!1:!0}async function I(a,c){({layersJSON:a}=await y.fetchFeatureService(a,c));if(!a)return null;const b=[...a.layers,...a.tables];return d=>b.find(e=>e.id===d.id)}async function H(a,c){const {layers:b,tables:d}=a;var e=[...(b??[]),...(d??[])];if(e.length){a=new Set;var g=[];for(const {layerType:f}of e)e=null==f?"ArcGISFeatureLayer":f,a.has(e)||(a.add(e),e=
c[k.layerTypeToLayerModuleType(e)],g.push(e()));var h=await Promise.all(g),m=new Map;Array.from(a).forEach((f,l)=>{m.set(f,h[l])});return({layerType:f})=>m.get(null==f?"ArcGISFeatureLayer":f)}}q.load=async function(a,c){const b=a.instance.portalItem;if(b?.id){await b.load(c);var d=a.instance.portalItem;if(!d?.type||!a.supportedTypes.includes(d.type))throw new n("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:d?.type,expectedType:a.supportedTypes.join(", ")});
a.validateItem&&a.validateItem(b);return D(a,c)}};Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});